# UI 用户反馈功能 - 使用指南

**实现日期:** 2025-12-04
**版本:** v1.0
**状态:** ✅ 已集成到 Streamlit 前端

---

## 🎯 功能概述

在 Streamlit UI 中，用户现在可以对 Smart RAG 的回答质量进行评分，帮助 AI 学习选择更好的策略。

### 核心特性

1. **即时反馈** - 每次 Smart RAG 回答后立即显示反馈按钮
2. **简单评分** - 👍 满意 / 😐 中立 / 👎 不满意
3. **可选评论** - 用户可以添加详细说明
4. **自定义评分** - 支持 0.0-1.0 的精确评分
5. **实时更新** - 反馈立即提交到后端，更新 bandit 权重

---

## 🖥️ UI 演示

### 1. Smart RAG 查询

用户在 RAG 模式下提问：

```
问题: "Who wrote Pride and Prejudice?"
```

**系统响应:**
- ✅ Selected: **Hybrid RAG**
- 💬 Answer: "Jane Austen wrote Pride and Prejudice..."
- 📊 Performance Metrics (Confidence, Latency, etc.)

---

### 2. 反馈按钮出现

答案显示后，自动出现反馈区域：

```
─────────────────────────────────────
💬 这个答案对你有帮助吗?
你的反馈帮助 AI 学习选择更好的策略

[👍 满意]  [😐 中立]  [👎 不满意]

▼ 💭 添加评论 (可选)
─────────────────────────────────────
```

---

### 3. 用户点击反馈

**场景 A: 满意**

用户点击 **[👍 满意]**

**结果:**
```
✅ 反馈已提交: 满意 👍
🔄 Feedback applied to hybrid strategy. Bandit weights updated.
```

**场景 B: 不满意**

用户点击 **[👎 不满意]**

**结果:**
```
✅ 反馈已提交: 不满意 👎
🔄 Feedback applied to hybrid strategy. Bandit weights updated.
```

---

### 4. 自定义评分 (高级)

用户点击 **▼ 💭 添加评论 (可选)** 展开:

```
说明原因 (可选):
┌──────────────────────────────────┐
│ 答案不准确，引用了错误的作者      │
└──────────────────────────────────┘

自定义评分: ━━━━━○━━━━━ 0.3
            0.0 (不满意)  →  1.0 (满意)

[📤 提交自定义反馈]
```

用户可以:
1. 输入评论 (最多 500 字)
2. 拖动滑块精确评分 (0.0-1.0)
3. 点击提交

---

## 📊 评分标准

| 按钮 | 评分 | 含义 | 使用场景 |
|------|------|------|---------|
| 👍 满意 | 1.0 | 答案准确，策略正确 | 完美回答 |
| 😐 中立 | 0.5 | 答案可用但不完美 | 基本满意 |
| 👎 不满意 | 0.0 | 答案错误或策略不当 | 需要改进 |
| 自定义 | 0.0-1.0 | 精确评分 | 特殊情况 |

---

## 🔄 反馈流程

```
1. 用户提问
   ↓
2. Smart RAG 选择策略并回答
   ↓
3. UI 显示答案 + 反馈按钮
   ↓
4. 用户点击反馈 (满意/中立/不满意)
   ↓
5. 前端提交到 /api/rag/feedback
   ↓
6. 后端更新 bandit 权重
   final_reward = 0.7 × user_rating + 0.3 × automated_reward
   ↓
7. UI 显示确认消息
   ↓
8. 反馈按钮变为"已提交"状态
```

---

## 💡 实际使用示例

### 示例 1: 答案错误

**查询:** "Who wrote DADDY TAKE ME SKATING?"

**Smart RAG 选择:** Graph RAG

**答案:** "Unknown" (实际应该是特定作者)

**用户操作:**
1. 点击 [👎 不满意]
2. 展开评论区
3. 输入: "答案不准确，应该用 Hybrid RAG 快速查找作者"
4. 点击 [📤 提交自定义反馈]

**结果:**
- Graph RAG 权重降低
- 下次类似作者查询更可能选择 Hybrid RAG

---

### 示例 2: 策略太慢但准确

**查询:** "Analyze the relationship evolution in Pride and Prejudice"

**Smart RAG 选择:** Iterative Self-RAG

**延迟:** 25秒

**答案:** 非常详细准确的分析

**自动 reward:** 0.3 (因为延迟超时)

**用户操作:**
1. 点击 [👍 满意]
2. (可选) 添加评论: "答案很详细，虽然慢但值得等待"

**结果:**
- Final reward = 0.7 × 1.0 + 0.3 × 0.3 = 0.79
- Iterative Self-RAG 权重提升
- 系统学习: 复杂分析查询值得牺牲延迟

---

### 示例 3: 策略完全错误

**查询:** "List all characters in Pride and Prejudice"

**Smart RAG 选择:** Graph RAG (35秒构建图)

**答案:** 正确列出了角色

**用户操作:**
1. 点击 [👎 不满意]
2. 添加评论: "简单列表查询应该用 Table RAG，不需要构建关系图"
3. 拖动滑块到 0.2
4. 提交

**结果:**
- Graph RAG 权重降低
- Table RAG 获得更多选中机会用于结构化查询

---

## 🎨 UI 截图 (文字描述)

### 反馈按钮 (未提交)

```
┌─────────────────────────────────────────────────────┐
│ 💬 这个答案对你有帮助吗?                              │
│ 你的反馈帮助 AI 学习选择更好的策略                     │
│                                                       │
│  [👍 满意]   [😐 中立]   [👎 不满意]                   │
│                                                       │
│  ▼ 💭 添加评论 (可选)                                  │
└─────────────────────────────────────────────────────┘
```

### 反馈已提交

```
┌─────────────────────────────────────────────────────┐
│ ✅ 已提交反馈: 满意                                    │
└─────────────────────────────────────────────────────┘
```

### 展开评论区

```
┌─────────────────────────────────────────────────────┐
│ 💬 这个答案对你有帮助吗?                              │
│ 你的反馈帮助 AI 学习选择更好的策略                     │
│                                                       │
│  [👍 满意]   [😐 中立]   [👎 不满意]                   │
│                                                       │
│  ▼ 💭 添加评论 (可选)                                  │
│  ┌─────────────────────────────────────────────────┐ │
│  │ 说明原因 (可选)                                    │ │
│  │ ┌─────────────────────────────────────────────┐ │ │
│  │ │                                              │ │ │
│  │ │ (文本框)                                      │ │ │
│  │ │                                              │ │ │
│  │ └─────────────────────────────────────────────┘ │ │
│  │                                                   │ │
│  │ 自定义评分:                                        │ │
│  │ ━━━━━━━○━━━━━ 0.5                                │ │
│  │ 0.0 (完全不满意) ←→ 1.0 (非常满意)                 │ │
│  │                                                   │ │
│  │        [📤 提交自定义反馈]                         │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 前端组件

**文件:** `frontend/components/feedback_ui.py`

**主要函数:**
- `render_feedback_buttons()` - 渲染反馈按钮和评论区
- `submit_feedback_to_backend()` - 提交反馈到后端 API
- `_handle_feedback()` - 处理反馈提交和 UI 更新

### 集成到 app.py

**位置:** Smart RAG 答案显示后

```python
# Display answer
st.markdown("### 💬 Answer")
st.markdown(answer)

# 🆕 User Feedback Buttons
query_id = result.get("query_id")
if query_id:
    backend_url = st.session_state.get("backend_url", "http://backend:8000")
    session_key = f"smart_rag_{query_id}"
    render_feedback_buttons(query_id, session_key, backend_url)
```

### Session State 管理

**防止重复提交:**
```python
# 标记已提交
st.session_state[f"feedback_submitted_{query_id}"] = True
st.session_state[f"feedback_rating_{query_id}"] = rating
```

**显示已提交状态:**
```python
if st.session_state.get(f"feedback_submitted_{query_id}", False):
    st.success("✅ 已提交反馈: 满意")
    return
```

---

## ⚠️ 注意事项

### 1. Query ID 有效期

- 后端只保留最近 **1000 个查询** 的 query_id
- 如果用户刷新页面或很久之后才反馈，query_id 可能已过期
- 过期时会显示错误: "❌ Query ID not found"

### 2. 重复反馈

- 每个 query_id 只能提交一次反馈 (Session 级别限制)
- 提交后按钮变为 "✅ 已提交反馈"
- 刷新页面后可以再次提交 (新的 session)

### 3. 网络错误

- 如果后端无响应，会显示: "❌ Feedback submission timed out"
- 用户可以稍后重试

---

## 📈 用户体验优势

### 1. 零学习成本

- 三个大按钮清晰直观
- 不需要阅读文档就能使用
- 符合常见的点赞/点踩交互习惯

### 2. 可选详细反馈

- 简单场景: 一键点击即可
- 复杂场景: 展开评论区添加详情
- 灵活适应不同用户需求

### 3. 即时反馈

- 提交后立即显示确认消息
- 明确告知哪个策略被更新
- 用户知道自己的反馈被重视

### 4. 非侵入式

- 反馈区域在答案下方，不影响阅读
- 默认折叠评论区，界面简洁
- 已提交后变为简单的确认消息

---

## 🚀 未来改进

### 1. 反馈历史

**功能:** 用户可以查看自己的历史反馈

```
我的反馈历史:
┌──────────────────────────────────────────┐
│ 2025-12-04 14:30 | Hybrid RAG | 满意 👍    │
│ 2025-12-04 14:25 | Graph RAG  | 不满意 👎 │
│ 2025-12-04 14:20 | Self-RAG   | 中立 😐   │
└──────────────────────────────────────────┘
```

### 2. 管理员仪表板

**功能:** 管理员可以查看全局反馈统计

```
反馈统计 (最近 24 小时):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Hybrid RAG:    👍 85% | 😐 10% | 👎 5%
Graph RAG:     👍 70% | 😐 15% | 👎 15%
Iterative:     👍 60% | 😐 20% | 👎 20%
Table RAG:     👍 90% | 😐 8%  | 👎 2%
```

### 3. 反馈提示

**功能:** 引导用户在关键场景提交反馈

```
💡 提示: 这个查询花了 35 秒，请告诉我们答案是否值得等待
[👍 值得等待]  [👎 太慢了]
```

### 4. 反馈奖励

**功能:** 激励用户提交有价值的反馈

```
✅ 感谢您的反馈！已为您的账户增加 10 积分
📊 您已提交 50 条反馈，帮助 AI 提升了 15% 的准确率
```

---

## ✅ 总结

### 已实现功能

1. ✅ **三个快速反馈按钮** (满意/中立/不满意)
2. ✅ **可选评论区** (最多 500 字)
3. ✅ **自定义评分滑块** (0.0-1.0)
4. ✅ **即时提交到后端** POST /api/rag/feedback
5. ✅ **防止重复提交** (Session State 管理)
6. ✅ **反馈确认消息** (显示更新的策略)
7. ✅ **集成到 Smart RAG** (答案显示后自动出现)

### 用户价值

- **简单:** 一键即可提交反馈，无需填写复杂表单
- **直观:** 点赞/点踩的通用交互方式
- **灵活:** 支持从简单到详细的各种反馈
- **实时:** 立即看到反馈被采纳的确认
- **有效:** 直接影响 AI 策略选择，改善未来体验

---

**版本:** 1.0
**状态:** ✅ Production Ready
**最后更新:** 2025-12-04
**相关文档:**
- [USER_FEEDBACK_MECHANISM.md](./USER_FEEDBACK_MECHANISM.md) - 后端技术文档
- [USER_FEEDBACK_QUICKSTART.md](./USER_FEEDBACK_QUICKSTART.md) - API 使用指南
